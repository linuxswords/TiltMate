# Android App Bundle (AAB) Build Guide

This guide explains how to build AAB files for Google Play Store distribution.

## What is AAB?

Android App Bundle (AAB) is Android's publishing format that defers APK generation and signing to Google Play. It allows Google Play to generate optimized APKs for each device configuration, resulting in smaller download sizes for users.

## Building AAB Files

### Local Development

#### Build AAB only
```bash
make build-bundle
```

Output: `app/build/outputs/bundle/release/app-release.aab`

#### Build both APK and AAB
```bash
make build-all-release
```

Outputs:
- APK: `app/build/outputs/apk/release/linuxswords-TiltMate-release.apk`
- AAB: `app/build/outputs/bundle/release/app-release.aab`

#### Using Gradle directly
```bash
# Build AAB
./gradlew bundleRelease -x lintVitalRelease -x lint

# Build both APK and AAB
./gradlew assembleRelease bundleRelease -x lintVitalRelease -x lint
```

## Automated Release Process

### GitHub Actions Workflow

The release workflow automatically builds both APK and AAB when you create a release tag:

1. **Create a tag:**
   ```bash
   make release-tag VERSION=1.0.0
   ```

2. **Push the tag:**
   ```bash
   make release-push
   ```

3. **Monitor the release:**
   ```bash
   make ci-status
   ```

The workflow will:
- Run all unit tests
- Run lint checks (non-blocking)
- Build both APK and AAB
- Create a GitHub release with both files attached
- Upload artifacts for 90 days retention

### Manual Workflow Trigger

You can also trigger a release manually via GitHub Actions:

1. Go to Actions → Release workflow
2. Click "Run workflow"
3. Enter the version number (e.g., `1.0.0`)
4. Click "Run workflow"

## Release Artifacts

Each release includes:

1. **APK File** (`linuxswords-TiltMate-release.apk`)
   - For direct installation on Android devices
   - Sideloading and distribution outside Play Store
   - GitHub Releases download

2. **AAB File** (`app-release.aab`)
   - For Google Play Store submission
   - Optimized delivery to users
   - Smaller download sizes (Google Play generates device-specific APKs)

## Signing

### Debug Builds
Debug builds use the default debug keystore automatically generated by Android SDK.

### Release Builds
Currently, release builds use the debug signing configuration. For production releases to Google Play, you should:

1. **Generate a release keystore:**
   ```bash
   keytool -genkey -v -keystore release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias release
   ```

2. **Add signing configuration to `app/build.gradle`:**
   ```gradle
   android {
       signingConfigs {
           release {
               storeFile file("release-key.jks")
               storePassword System.getenv("KEYSTORE_PASSWORD")
               keyAlias "release"
               keyPassword System.getenv("KEY_PASSWORD")
           }
       }
       buildTypes {
           release {
               signingConfig signingConfigs.release
               // ... other settings
           }
       }
   }
   ```

3. **Configure GitHub Secrets:**
   - `KEYSTORE_PASSWORD`: Your keystore password
   - `KEY_PASSWORD`: Your key password
   - `KEYSTORE_FILE`: Base64-encoded keystore file

## Play Store Submission

### First-time Setup

1. Create a Google Play Developer account
2. Create a new application in Play Console
3. Complete store listing (description, screenshots, etc.)

### Uploading AAB

1. Build the AAB (or download from GitHub release)
2. Go to Play Console → Your App → Release → Production
3. Click "Create new release"
4. Upload the AAB file
5. Fill in release notes
6. Review and rollout

### App Signing by Google Play

Google Play requires you to enroll in App Signing:

1. When uploading your first release, Play Console will prompt you to enroll
2. Google will manage your app signing key
3. You upload your app signed with an upload key
4. Google re-signs with the app signing key before distribution

## File Sizes

Typical sizes for TiltMate:
- **APK**: ~6.5 MB (universal APK for all devices)
- **AAB**: ~4.7 MB (base bundle, Play generates device-specific APKs of ~3-5 MB)

## Troubleshooting

### Build fails with lint errors

The AAB build automatically skips lint tasks that may fail with certain Gradle/AGP combinations:
```bash
./gradlew bundleRelease -x lintVitalRelease -x lint
```

### AAB file not found

Ensure you're looking in the correct output directory:
```bash
ls -lh app/build/outputs/bundle/release/
```

### Signing errors

For release builds, ensure signing configuration is properly set up in `app/build.gradle` and required environment variables are available.

## CI/CD Integration

The project includes GitHub Actions workflows:

- **android-ci.yml**: Runs on every push/PR, builds debug APK
- **release.yml**: Runs on tag push, builds both APK and AAB

See `.github/workflows/` for workflow configurations.

## Resources

- [Android App Bundle Documentation](https://developer.android.com/guide/app-bundle)
- [Play Console Help](https://support.google.com/googleplay/android-developer)
- [App Signing by Google Play](https://support.google.com/googleplay/android-developer/answer/9842756)
