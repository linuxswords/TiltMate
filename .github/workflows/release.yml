name: Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate debug keystore
        run: |
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Run tests
        run: ./gradlew test --console=plain --no-daemon

      - name: Run lint
        run: ./gradlew lint --console=plain --no-daemon
        continue-on-error: true

      - name: Build release APK
        run: ./gradlew assembleRelease -x lint --console=plain --no-daemon

      - name: Build release AAB
        run: ./gradlew bundleRelease -x lintVitalRelease -x lint --console=plain --no-daemon

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Get APK info
        id: apk_info
        run: |
          APK_PATH="app/build/outputs/apk/release/TiltMate-release.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "APK built successfully!"
          echo "Size: $APK_SIZE"
          echo "Path: $APK_PATH"

      - name: Get AAB info
        id: aab_info
        run: |
          AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
          AAB_SIZE=$(du -h "$AAB_PATH" | cut -f1)
          echo "AAB_PATH=$AAB_PATH" >> $GITHUB_OUTPUT
          echo "AAB_SIZE=$AAB_SIZE" >> $GITHUB_OUTPUT
          echo "AAB built successfully!"
          echo "Size: $AAB_SIZE"
          echo "Path: $AAB_PATH"

      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CHANGELOG="Manual release v${{ inputs.version }}"
          else
            # Get commits since last tag
            PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
            if [ -z "$PREV_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
            else
              CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            fi
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: TiltMate ${{ steps.version.outputs.VERSION }}
          body: |
            ## TiltMate v${{ steps.version.outputs.VERSION }}

            ### ðŸ“± Download

            Download `TiltMate-release.apk` (${{ steps.apk_info.outputs.APK_SIZE }})

            ### ðŸ“‹ Changes
            ${{ steps.changelog.outputs.CHANGELOG }}

            ### ðŸ“¦ Installation
            1. Download `TiltMate-release.apk` below
            2. Enable "Install from unknown sources" in Android settings
            3. Open the APK file and install

            ### ðŸŽ® Features
            - Tilt-based clock control
            - Multiple time settings (3+0, 3+2, 5+0, 5+3, 10+0, 10+5, 15+10, plus custom)
            - Fischer increment support
            - Gesture controls (tap to pause, double-tap to reset)

            ---
            **Min Android Version:** 5.0 (API 21)
            **Target Android Version:** 15 (API 36)

            **Note:** AAB bundle is available as a build artifact for Play Store submissions.
          draft: false
          prerelease: false
          files: |
            app/build/outputs/apk/release/TiltMate-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: TiltMate-apk-v${{ steps.version.outputs.VERSION }}
          path: app/build/outputs/apk/release/TiltMate-release.apk
          retention-days: 90

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: TiltMate-aab-v${{ steps.version.outputs.VERSION }}
          path: app/build/outputs/bundle/release/app-release.aab
          retention-days: 90
